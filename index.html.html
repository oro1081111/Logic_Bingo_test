<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>é‚è¼¯è³“æœï¼ˆ2Ã—2 / 3Ã—3 / 4Ã—4 / 5Ã—5ï¼‰</title>
<style>
  :root{
    --bg:#f7f8fb; --panel:#ffffff; --text:#1f2937; --muted:#6b7280;
    --ok:#00DB00;     --ok-bg:#E8FFE8;  --ok-border:#00DB00;
    --bad:#EA0000;    --bad-bg:#FFE8E8; --bad-border:#EA0000;
    --cell:#ffffff; --cellBorder:#e5e7eb; --ring:#3b82f6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"PingFang TC","Microsoft JhengHei",sans-serif;
    display:flex; align-items:stretch; justify-content:center; padding:14px;
    -webkit-text-size-adjust:100%;
  }
  .wrap{width:min(760px,96vw); margin:auto;}
  header{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px;}
  h1{font-size:18px; margin:0}
  .legend{font-size:12px; color:var(--muted)}
  .legend .chip{display:inline-block; padding:1px 8px; border-radius:999px; margin-left:6px; border:1px solid #d1d5db}
  .chip.ok{background:var(--ok-bg); color:var(--ok); border-color:var(--ok-border)}
  .chip.bad{background:var(--bad-bg); color:var(--bad); border-color:var(--bad-border)}

  .toolbar{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; margin:12px 0 8px;
    background:var(--panel); padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb;
    box-shadow: 0 1px 8px rgba(0,0,0,.04);
  }
  .left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .select{
    padding:7px 10px; border:1px solid #d1d5db; border-radius:9px; background:#fff; font-size:14px;
  }
  .btn{
    background:#ffffff; color:#111827; border:1px solid #d1d5db;
    padding:8px 10px; border-radius:9px; font-size:14px; cursor:pointer;
    transition: background .15s ease, transform .06s ease, border-color .15s ease, box-shadow .15s ease;
    touch-action:manipulation;
  }
  .btn:hover{ background:#f3f4f6; border-color:#cbd5e1 }
  .btn:active{ transform: translateY(1px) }
  .status{ color:#374151; font-size:13px }
  .status strong{ color:#111827 }

  .board{
    width:min(620px,94vw);
    margin:0 auto;
    display:grid; gap:8px;
    touch-action:manipulation;
  }
  .cell{
    position:relative; border-radius:12px; padding:8px;
    background:var(--cell); border:1px solid var(--cellBorder);
    aspect-ratio:1/1; overflow:hidden; text-align:center;
    display:grid; grid-auto-rows:max-content; row-gap:6px;
    place-content:center; place-items:center;
    transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease;
    outline:none; box-shadow: 0 1px 6px rgba(0,0,0,.04);
    content-visibility:auto; contain-intrinsic-size: 200px 200px;
  }
  .cell:hover{ transform:translateY(-1px); border-color:#d1d5db }
  .cell:focus-visible{ box-shadow:0 0 0 3px var(--ring) ; }

  .desc{
    font-size:clamp(11px,2.0vw,15px);
    line-height:1.35; color:#111827; letter-spacing:.2px;
    padding:0 2px; max-width:100%;
    overflow-wrap:anywhere; word-break:break-word; white-space:normal;
    text-wrap:balance;
  }
  .mark{
    font-size:clamp(22px,5.2vw,30px);
    line-height:1; width:1.2em; text-align:center; user-select:none;
  }
  .cell.ok{ background:var(--ok-bg); border-color:var(--ok-border); box-shadow: 0 1px 8px rgba(0,219,0,.12); }
  .cell.bad{ background:var(--bad-bg); border-color:var(--bad-border); box-shadow: 0 1px 8px rgba(234,0,0,.12); }

  .sol{
    position:absolute; right:6px; bottom:6px;
    font-size:clamp(14px,4.8vw,20px);
    opacity:.35; color:var(--ok); pointer-events:none; user-select:none;
    display:none;
  }

  .solved{
    margin-top:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--ok-border);
    background:var(--ok-bg); color:#075e07; display:none;
    box-shadow: 0 1px 8px rgba(0,219,0,.12); font-size:14px; text-align:center;
  }
  .solved.show{ display:block; }

  .foot{
    margin-top:10px; font-size:12px; color:#6b7280;
    border-top:1px dashed #d1d5db; padding-top:8px; text-align:center;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>é‚è¼¯è³“æœ</h1>
      <div class="legend">
        ç‹€æ…‹ï¼š
        <span class="chip ok">ç¬¦åˆï¼ˆç¶ ï¼‰</span>
        <span class="chip bad">æœªç¬¦åˆï¼ˆç´…ï¼‰</span>
      </div>
    </header>

    <div class="toolbar">
      <div class="left">
        <label for="size" class="status">æ£‹ç›¤å°ºå¯¸ï¼š</label>
        <select id="size" class="select">
          <option value="2">2Ã—2</option>
          <option value="3">3Ã—3</option>
          <option value="4" selected>4Ã—4</option>
          <option value="5">5Ã—5</option>
        </select>
        <div class="status">ç›®å‰å‹¾é¸æ•¸ï¼š<strong id="cnt">0</strong>/<strong id="total">16</strong></div>
      </div>
      <div>
        <button class="btn" id="btn-new">ç”¢ç”Ÿæ–°é¡Œ</button>
        <button class="btn" id="btn-reset">é‡è¨­ç›¤é¢</button>
        <button class="btn" id="btn-solution">é¡¯ç¤ºè§£ç­”</button>
      </div>
    </div>

    <section class="board" id="board" aria-label="é‚è¼¯è³“æœæ£‹ç›¤"></section>

    <div id="solved" class="solved">ğŸ‰ æ­å–œï¼ç›®å‰æ‰€æœ‰æ ¼å­çš„ã€Œæ˜¯å¦æ‰“å‹¾ã€çš†èˆ‡å„è‡ªæè¿°çš„çœŸå‡ä¸€è‡´ï¼ˆå…¨éƒ¨ç¶ è‰²ï¼‰ã€‚</div>

    <div class="foot">
      é»æ“Šæ ¼å­åˆ‡æ› ç©ºç™½ â†’ âœ… â†’ âŒï¼ˆç©ºç™½/âŒçš†è¦–ç‚ºæœªå‹¾ï¼‰ã€‚<br>
      è‹¥è©²æ ¼æè¿°èˆ‡ã€Œæ˜¯å¦æ‰“å‹¾ã€åœ¨ç•¶å‰ç›¤é¢çš„çœŸå‡ä¸€è‡´ â†’ ç¶ ï¼›å¦å‰‡ç´…ã€‚<br>
      è¡Œï¼ç›´ï¼ˆcolumnï¼‰ã€åˆ—ï¼æ©«ï¼ˆrowï¼‰ï¼Œå‘¨åœ=å‘¨åœ8å®®æ ¼ï¼Œä¸å«è‡ªèº«ã€‚<br>
      å¥§ç¾…æ¡ŒéŠè¨­è¨ˆå·¥ä½œå®¤-ç¨‹å¼å¯¦ä½œç·´ç¿’<br>
    </div>
  </div>

<script>
/* ============ ç‹€æ…‹ ============ */
let N = 4;
const BLANK=0, CHECK=1, CROSS=2;
let board = makeEmpty(N);
let answer = makeEmpty(N);
let rules  = makeEmpty(N);
let showSolution = false;
let ACTIVE_DESCS = [];     // æœ¬é¡Œæè¿°åº«ï¼ˆä¾ N ç”Ÿæˆä¸€æ¬¡ï¼‰
let BOARD_CTX = null;      // ç¾è¡Œç›¤é¢å¿«å–ï¼ˆæ¯æ¬¡ render ä¸€æ¬¡ï¼‰
let ANSWER_CTX = null;     // ç­”æ¡ˆç›¤é¢å¿«å–ï¼ˆå‡ºé¡Œæ™‚è¨ˆç®—ä¸€æ¬¡ï¼‰

const boardEl = document.getElementById('board');
const cntEl = document.getElementById('cnt');
const totalEl = document.getElementById('total');
const solvedEl = document.getElementById('solved');
const btnSolution = document.getElementById('btn-solution');
const sizeSel = document.getElementById('size');

/* ============ é–€æª»è¨­å®šï¼ˆå« GT æ˜ å°„ï¼‰ ============ */
function lineThreshold(N){ return Math.max(1, Math.ceil(0.6*N)); }   // è¡Œ/åˆ—é–€æª»ï¼ˆâ‰§T / â‰¦T-1ï¼‰
function globalThreshold(N){
  if (N===2) return 3;
  if (N===3) return 5;
  if (N===4) return 9;
  if (N===5) return 13;
  return Math.max(1, Math.ceil(0.35*N*N));
}
function hasQuadrantRules(N){ return N>=3; }

/* ============ ç›¤é¢å¿«å–ï¼ˆå–®æ¬¡ O(N^2)ï¼Œä¹‹å¾Œ O(1) æŸ¥è©¢ï¼‰ ============ */
function buildContext(b){
  const rows=new Array(N).fill(0), cols=new Array(N).fill(0);
  let total=0;
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      if(b[r][c]===CHECK){ rows[r]++; cols[c]++; total++; }
    }
  }
  const corners = (b[0][0]===CHECK) + (b[0][N-1]===CHECK) + (b[N-1][0]===CHECK) + (b[N-1][N-1]===CHECK);

  // å‰ç¶´å’Œï¼ˆæŸ¥ä»»æ„çŸ©å½¢å…§å‹¾é¸æ•¸ï¼‰
  const pref = Array.from({length:N+1},()=>new Array(N+1).fill(0));
  for(let r=1;r<=N;r++){
    for(let c=1;c<=N;c++){
      const v = (b[r-1][c-1]===CHECK)?1:0;
      pref[r][c]=pref[r-1][c]+pref[r][c-1]-pref[r-1][c-1]+v;
    }
  }
  const sumRect=(r0,c0,h,w)=>{
    const r1=r0+h, c1=c0+w;
    const R1=Math.min(r1,N), C1=Math.min(c1,N);
    const R0=Math.max(0,r0), C0=Math.max(0,c0);
    return pref[R1][C1]-pref[R0][C1]-pref[R1][C0]+pref[R0][C0];
  };

  // å°è§’ç·š
  let mainAll=true, antiAll=true, mainZero=true, antiZero=true;
  for(let i=0;i<N;i++){
    const a=(b[i][i]===CHECK), d=(b[i][N-1-i]===CHECK);
    if(!a) mainAll=false; if(a) mainZero=false;
    if(!d) antiAll=false; if(d) antiZero=false;
  }

  // é„°å±…çŸ©é™£
  const nb = Array.from({length:N},()=>new Array(N).fill(0));
  let nbMax=0, nbMin=8;
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      let s=0;
      for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
        if(dr===0&&dc===0) continue;
        const rr=r+dr, cc=c+dc;
        if(rr>=0&&rr<N&&cc>=0&&cc<N && b[rr][cc]===CHECK) s++;
      }
      nb[r][c]=s; if(s>nbMax) nbMax=s; if(s<nbMin) nbMin=s;
    }
  }

  // æ•´è¡Œæ•´åˆ—ã€2Ã—2ã€ç¸±å‘ç›¸é„°ã€å…§éƒ¨å››å‘
  let fullRowChecked=false, fullColChecked=false, fullRowUnchecked=false, fullColUnchecked=false;
  let fullRowCount=0, fullColCount=0;
  for(let r=0;r<N;r++){
    if(rows[r]===N){ fullRowChecked=true; fullRowCount++; }
    if(rows[r]===0){ fullRowUnchecked=true; }
  }
  for(let c=0;c<N;c++){
    if(cols[c]===N){ fullColChecked=true; fullColCount++; }
    if(cols[c]===0){ fullColUnchecked=true; }
  }
  const linesChecked = fullRowCount + fullColCount + (mainAll?1:0) + (antiAll?1:0);

  let ex2x2AllChecked=false, ex2x2AllUnchecked=false;
  for(let r=0;r<N-1;r++) for(let c=0;c<N-1;c++){
    const s=sumRect(r,c,2,2);
    if(s===4) ex2x2AllChecked=true;
    if(s===0) ex2x2AllUnchecked=true;
  }

  let vertAdjBothChecked=false, vertAdjBothUnchecked=false;
  for(let r=0;r<N-1;r++) for(let c=0;c<N;c++){
    if(b[r][c]===CHECK && b[r+1][c]===CHECK) vertAdjBothChecked=true;
    if(b[r][c]!==CHECK && b[r+1][c]!==CHECK) vertAdjBothUnchecked=true;
  }

  let orthAllChecked=false, orthAllUnchecked=false;
  if(N>=3){
    for(let r=1;r<N-1;r++) for(let c=1;c<N-1;c++){
      const u=(b[r-1][c]===CHECK), d=(b[r+1][c]===CHECK), l=(b[r][c-1]===CHECK), ri=(b[r][c+1]===CHECK);
      if(u&&d&&l&&ri) orthAllChecked=true;
      if(!u&&!d&&!l&&!ri) orthAllUnchecked=true;
    }
  }

  return {
    total, rows, cols, corners,
    nb, nbMax, nbMin,
    sumRect,
    fullRowChecked, fullRowUnchecked, fullColChecked, fullColUnchecked,
    mainAll, antiAll, mainZero, antiZero,
    ex2x2AllChecked, ex2x2AllUnchecked,
    vertAdjBothChecked, vertAdjBothUnchecked,
    orthAllChecked, orthAllUnchecked,
    linesChecked
  };
}

/* ============ æè¿°åº«ï¼ˆä¾ N ç”Ÿæˆï¼›eval ä½¿ç”¨å¿«å– ctxï¼‰ ============ */
function getBaseDescs(N){
  const LT = lineThreshold(N);
  const GT = globalThreshold(N);
  const base = [
    { pos:'é€™å€‹æ ¼å­å‘¨åœçš„æ‰“å‹¾æ•¸æ˜¯å¥‡æ•¸', neg:'é€™å€‹æ ¼å­å‘¨åœçš„æ‰“å‹¾æ•¸æ˜¯å¶æ•¸',
      eval:(ctx,r,c)=> (ctx.nb[r][c]%2===1) },

    { pos:'è‡³å°‘å­˜åœ¨ä¸€æ•´åˆ—å…¨éƒ¨æ‰“å‹¾', neg:'ä¸å­˜åœ¨ä¸€æ•´åˆ—å…¨éƒ¨æ‰“å‹¾',
      eval:(ctx)=> ctx.fullRowChecked },
    { pos:'è‡³å°‘å­˜åœ¨ä¸€æ•´è¡Œå…¨éƒ¨æ‰“å‹¾', neg:'ä¸å­˜åœ¨ä¸€æ•´è¡Œå…¨éƒ¨æ‰“å‹¾',
      eval:(ctx)=> ctx.fullColChecked },
    { pos:'å­˜åœ¨ä¸€æ¢å°è§’ç·šå…¨éƒ¨æ‰“å‹¾', neg:'ä¸å­˜åœ¨ä»»ä½•å°è§’ç·šå…¨éƒ¨æ‰“å‹¾',
      eval:(ctx)=> ctx.mainAll || ctx.antiAll },

    { pos:'è‡³å°‘å­˜åœ¨ä¸€æ•´åˆ—å…¨éƒ¨ä¸å‹¾', neg:'ä¸å­˜åœ¨ä¸€æ•´åˆ—å…¨éƒ¨ä¸å‹¾',
      eval:(ctx)=> ctx.fullRowUnchecked },
    { pos:'è‡³å°‘å­˜åœ¨ä¸€æ•´è¡Œå…¨éƒ¨ä¸å‹¾', neg:'ä¸å­˜åœ¨ä¸€æ•´è¡Œå…¨éƒ¨ä¸å‹¾',
      eval:(ctx)=> ctx.fullColUnchecked },
    { pos:'å­˜åœ¨ä¸€æ¢å°è§’ç·šå…¨éƒ¨ä¸å‹¾', neg:'ä¸å­˜åœ¨ä»»ä½•å°è§’ç·šå…¨éƒ¨ä¸å‹¾',
      eval:(ctx)=> ctx.mainZero || ctx.antiZero },

    { pos:'å››å€‹è§’çš„æ‰“å‹¾æ•¸æ˜¯å¥‡æ•¸', neg:'å››å€‹è§’çš„æ‰“å‹¾æ•¸æ˜¯å¶æ•¸',
      eval:(ctx)=> (ctx.corners%2===1) },
    { pos:'å››å€‹è§’çš„æ‰“å‹¾æ•¸â‰§3', neg:'å››å€‹è§’çš„æ‰“å‹¾æ•¸â‰¦2',
      eval:(ctx)=> (ctx.corners>=3) },

    { pos:'æ•´å¼µè¡¨æ‰“å‹¾çš„æ ¼å­æ•¸æ˜¯å¥‡æ•¸', neg:'æ•´å¼µè¡¨æ‰“å‹¾çš„æ ¼å­æ•¸æ˜¯å¶æ•¸',
      eval:(ctx)=> (ctx.total%2===1) },

    { pos:'å­˜åœ¨ä¸€å€‹ 2Ã—2 å››å®®æ ¼å…¨éƒ¨æ‰“å‹¾', neg:'ä¸å­˜åœ¨ 2Ã—2 å››å®®æ ¼å…¨éƒ¨æ‰“å‹¾',
      eval:(ctx)=> ctx.ex2x2AllChecked },
    { pos:'å­˜åœ¨ä¸€å€‹ 2Ã—2 å››å®®æ ¼å…¨éƒ¨ä¸å‹¾', neg:'ä¸å­˜åœ¨ 2Ã—2 å››å®®æ ¼å…¨éƒ¨ä¸å‹¾',
      eval:(ctx)=> ctx.ex2x2AllUnchecked },

    { pos:'å­˜åœ¨ä¸Šä¸‹ç›¸é„°ä¸”å‡è¢«æ‰“å‹¾çš„å…©å€‹æ ¼å­', neg:'ä¸å­˜åœ¨ä¸Šä¸‹ç›¸é„°ä¸”å‡è¢«æ‰“å‹¾çš„å…©å€‹æ ¼å­',
      eval:(ctx)=> ctx.vertAdjBothChecked },
    { pos:'å­˜åœ¨ä¸Šä¸‹ç›¸é„°ä¸”å‡ä¸æ‰“å‹¾çš„å…©å€‹æ ¼å­', neg:'ä¸å­˜åœ¨ä¸Šä¸‹ç›¸é„°ä¸”å‡ä¸æ‰“å‹¾çš„å…©å€‹æ ¼å­',
      eval:(ctx)=> ctx.vertAdjBothUnchecked },

    { pos:'é€™ä¸€æ ¼æ‰€åœ¨åˆ—çš„æ‰“å‹¾æ•¸é‡<æ‰€åœ¨è¡Œ', neg:'é€™ä¸€æ ¼æ‰€åœ¨åˆ—çš„æ‰“å‹¾æ•¸é‡â‰§æ‰€åœ¨è¡Œ',
      eval:(ctx,r,c)=> ctx.rows[r] < ctx.cols[c] },
    { pos:'é€™ä¸€æ ¼æ‰€åœ¨åˆ—çš„æ‰“å‹¾æ•¸é‡>æ‰€åœ¨è¡Œ', neg:'é€™ä¸€æ ¼æ‰€åœ¨åˆ—çš„æ‰“å‹¾æ•¸é‡â‰¦æ‰€åœ¨è¡Œ',
      eval:(ctx,r,c)=> ctx.rows[r] > ctx.cols[c] },

    { pos:`æ•´å¼µè¡¨æ‰“å‹¾çš„æ ¼å­æ•¸â‰§${GT}`, neg:`æ•´å¼µè¡¨æ‰“å‹¾çš„æ ¼å­æ•¸â‰¦${GT-1}`,
      eval:(ctx)=> (ctx.total >= GT) },

    /* ä½ çš„æ–°å¢ï¼šå››å‘çš†å‹¾ / çš†ä¸å‹¾ã€é„°å±…æ•¸é–€æª» */
    { pos:'å­˜åœ¨ä¸Šä¸‹å·¦å³å‡è¢«æ‰“å‹¾çš„æ ¼å­', neg:'ä¸å­˜åœ¨ä¸Šä¸‹å·¦å³å‡è¢«æ‰“å‹¾çš„æ ¼å­',
      eval:(ctx)=> ctx.orthAllChecked },
    { pos:'å­˜åœ¨ä¸Šä¸‹å·¦å³å‡ä¸æ‰“å‹¾çš„æ ¼å­', neg:'ä¸å­˜åœ¨ä¸Šä¸‹å·¦å³å‡ä¸æ‰“å‹¾çš„æ ¼å­',
      eval:(ctx)=> ctx.orthAllUnchecked },
    { pos:'å­˜åœ¨å‘¨åœæ‰“å‹¾æ•¸é‡ â‰¥ 6 çš„æ ¼å­', neg:'ä¸å­˜åœ¨å‘¨åœæ‰“å‹¾æ•¸é‡ â‰¥ 6 çš„æ ¼å­',
      eval:(ctx)=> (ctx.nbMax >= 6) },
    { pos:'å­˜åœ¨å‘¨åœæ‰“å‹¾æ•¸é‡ â‰¤ 2 çš„æ ¼å­', neg:'ä¸å­˜åœ¨å‘¨åœæ‰“å‹¾æ•¸é‡ â‰¤ 2 çš„æ ¼å­',
      eval:(ctx)=> (ctx.nbMin <= 2) },

    /* ä½ çš„æ–°å¢ï¼šæ‰“å‹¾é€£ç·šæ•¸é‡ï¼ˆè¡Œ/åˆ—/å°è§’ç·šæ»¿ç·šï¼‰ */
    { pos:'æ‰“å‹¾é€£ç·šæ•¸é‡è‡³å°‘2', neg:'æ‰“å‹¾é€£ç·šæ•¸é‡ä¸è¶…é1',
      eval:(ctx)=> (ctx.linesChecked >= 2) },
    { pos:'å­˜åœ¨è‡³å°‘1æ¢æ‰“å‹¾é€£ç·š', neg:'ä¸å­˜åœ¨ä»»ä½•æ‰“å‹¾é€£ç·š',
      eval:(ctx)=> (ctx.linesChecked >= 1) },
  ];

  // ä¸­å¿ƒï¼ˆå¥‡ Nï¼šå–®ä¸­å¿ƒï¼›å¶ Nï¼šä¸­å¿ƒ 2Ã—2 è‡³å°‘ä¸€æ ¼ï¼‰
  if(N%2===1){
    const mid=Math.floor(N/2);
    base.push({ pos:'ä¸­å¿ƒæ ¼è¢«æ‰“å‹¾', neg:'ä¸­å¿ƒæ ¼æ²’æœ‰è¢«æ‰“å‹¾',
      eval:(ctx)=> (ctx.sumRect(mid,mid,1,1)===1) });
  }else{
    base.push({ pos:'ä¸­å¿ƒå››æ ¼ä¸­è‡³å°‘ä¸€æ ¼è¢«æ‰“å‹¾', neg:'ä¸­å¿ƒå››æ ¼ä¸­æ²’æœ‰ä»»ä½•æ ¼è¢«æ‰“å‹¾',
      eval:(ctx)=> (ctx.sumRect(N/2-1,N/2-1,2,2) >= 1) });
  }

  // å››è§’ 2Ã—2ï¼ˆåƒ… Nâ‰¥3ï¼‰
  if(hasQuadrantRules(N)){
    base.push(
      { pos:'å·¦ä¸Šå››æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§2', neg:'å·¦ä¸Šå››æ ¼çš„æ‰“å‹¾æ•¸é‡<2', eval:(ctx)=> ctx.sumRect(0,0,2,2)>=2 },
      { pos:'å³ä¸Šå››æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§2', neg:'å³ä¸Šå››æ ¼çš„æ‰“å‹¾æ•¸é‡<2', eval:(ctx)=> ctx.sumRect(0,N-2,2,2)>=2 },
      { pos:'å·¦ä¸‹å››æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§2', neg:'å·¦ä¸‹å››æ ¼çš„æ‰“å‹¾æ•¸é‡<2', eval:(ctx)=> ctx.sumRect(N-2,0,2,2)>=2 },
      { pos:'å³ä¸‹å››æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§2', neg:'å³ä¸‹å››æ ¼çš„æ‰“å‹¾æ•¸é‡<2', eval:(ctx)=> ctx.sumRect(N-2,N-2,2,2)>=2 },
    );
  }

  // å››è§’ä¹å®®æ ¼ï¼ˆåƒ… Nâ‰¥4ï¼‰
  if(N>=4){
    base.push(
      { pos:'å·¦ä¸Šä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§5', neg:'å·¦ä¸Šä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰¦4', eval:(ctx)=> ctx.sumRect(0,0,3,3) >= 5 },
      { pos:'å³ä¸Šä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§5', neg:'å³ä¸Šä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰¦4', eval:(ctx)=> ctx.sumRect(0,N-3,3,3) >= 5 },
      { pos:'å·¦ä¸‹ä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§5', neg:'å·¦ä¸‹ä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰¦4', eval:(ctx)=> ctx.sumRect(N-3,0,3,3) >= 5 },
      { pos:'å³ä¸‹ä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰§5', neg:'å³ä¸‹ä¹å®®æ ¼çš„æ‰“å‹¾æ•¸é‡â‰¦4', eval:(ctx)=> ctx.sumRect(N-3,N-3,3,3) >= 5 },
    );
  }

  return base;
}

function buildLineDescs(N){
  const T = lineThreshold(N);
  const list = [];
  for(let j=1;j<=N;j++){
    list.push({
      pos:`ç¬¬${j}è¡Œçš„æ‰“å‹¾æ•¸â‰§${T}`,
      neg:`ç¬¬${j}è¡Œçš„æ‰“å‹¾æ•¸â‰¦${T-1}`,
      eval:(ctx)=> (ctx.cols[j-1] >= T)   // è¡Œï¼ç›´ï¼ˆcolumn jï¼‰
    });
  }
  for(let i=1;i<=N;i++){
    list.push({
      pos:`ç¬¬${i}åˆ—çš„æ‰“å‹¾æ•¸â‰§${T}`,
      neg:`ç¬¬${i}åˆ—çš„æ‰“å‹¾æ•¸â‰¦${T-1}`,
      eval:(ctx)=> (ctx.rows[i-1] >= T)   // åˆ—ï¼æ©«ï¼ˆrow iï¼‰
    });
  }
  return list;
}

/* ============ æ–°é¡Œï¼šç­”æ¡ˆ + æè¿° + åˆ†æ´¾ï¼ˆç›¡é‡ä¸åŒï¼‰ ============ */
function chooseAnswerRange(N){
  if(N===2) return [1,3];
  if(N===3) return [3,6];
  if(N===4) return [5,11];
  if(N===5) return [7,18];
  const cells=N*N; return [Math.ceil(0.35*cells), Math.floor(0.65*cells)];
}
function newPuzzle(){
  // 1) ç­”æ¡ˆï¼ˆä¾ä½ æŒ‡å®šçš„å€é–“ï¼‰
  answer = makeEmpty(N);
  const [minC,maxC] = chooseAnswerRange(N);
  const target = randInt(minC, maxC);
  const positions = Array.from({length:N*N},(_,i)=>i); shuffle(positions);
  for(let k=0;k<target;k++){ const idx=positions[k]; answer[Math.floor(idx/N)][idx%N]=1; }

  // 2) æè¿°åº«
  ACTIVE_DESCS = getBaseDescs(N).concat(buildLineDescs(N));

  // 3) åˆ†æ´¾ï¼ˆç›¡é‡ä¸åŒï¼šå…ˆç”¨å®Œä¸€è¼ªå†é‡æ´—ï¼‰
  ANSWER_CTX = buildContext(answer);
  rules = assignRoundRobinRules(ACTIVE_DESCS, ANSWER_CTX);

  // 4) åˆå§‹åŒ–ç©å®¶ç›¤é¢
  board = makeEmpty(N);
  showSolution = false;
  document.getElementById('btn-solution').textContent = 'é¡¯ç¤ºè§£ç­”';
  totalEl.textContent = String(N*N);

  // 5) ç¹ªè£½ï¼ˆä¸€æ¬¡å¯«å…¥æè¿°ï¼›ç¸®å­—åªåœ¨æ­¤è™•åšï¼‰
  renderBoardSkeleton();
  render();
  fitAllDescriptions();
}

/* ç›¡é‡ä¸åŒï¼šæŠŠ DESCS äº‚åºå¾Œä¾åºæŒ‡æ´¾ï¼Œç”¨å®Œä¸€è¼ªå†é‡æ´—ã€‚ç”¨ç­”æ¡ˆå¿«å–ä¾†æ±ºå®šæ­£/åã€‚ */
function assignRoundRobinRules(DESCS, answerCtx){
  const order = Array.from({length:DESCS.length},(_,i)=>i); shuffle(order);
  let ptr=0;
  const tmp = makeEmpty(N);
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      if(ptr>=order.length){ shuffle(order); ptr=0; }
      const idx=order[ptr++], d=DESCS[idx];
      const truthOnAnswer = !!d.eval(answerCtx, r, c);
      const wantTrue = (answer[r][c]===CHECK);
      tmp[r][c] = { idx, negate: (truthOnAnswer !== wantTrue) };
    }
  }
  return tmp;
}

/* ============ æ¸²æŸ“ï¼ˆæ¯æ¬¡ O(N^2)ï¼Œæ¢ä»¶åˆ¤æ–·ç”¨å¿«å– ctxï¼‰ ============ */
function computeTruthOnCurrent(r,c){
  const rule = rules[r][c]; if(!rule) return false;
  const d = ACTIVE_DESCS[rule.idx];
  const base = !!d.eval(BOARD_CTX, r, c);
  return rule.negate ? !base : base;
}

function render(){
  BOARD_CTX = buildContext(board);
  cntEl.textContent = String(BOARD_CTX.total);
  let allSatisfied=true;

  document.querySelectorAll('.cell').forEach(cell=>{
    const r=+cell.dataset.r, c=+cell.dataset.c;
    const markEl=cell.querySelector('[data-mark]');
    const solEl = cell.querySelector('[data-sol]');

    const state=board[r][c];
    markEl.textContent = state===CHECK ? 'âœ…' : (state===CROSS ? 'âŒ' : 'ã€€');

    solEl.style.display = (showSolution && answer[r][c]===CHECK) ? 'block' : 'none';

    const truth = computeTruthOnCurrent(r,c);
    const satisfied = (state===CHECK)===truth;
    cell.classList.toggle('ok',satisfied);
    cell.classList.toggle('bad',!satisfied);
    if(!satisfied) allSatisfied=false;
  });

  solvedEl.classList.toggle('show',allSatisfied);
}

function advance(r,c){
  board[r][c]=(board[r][c]+1)%3;
  render(); // ä¸ç¸®å­—
}

/* ============ UI ============ */
function renderBoardSkeleton(){
  boardEl.style.gridTemplateColumns = `repeat(${N},1fr)`;
  boardEl.innerHTML='';
  for(let r=0;r<N;r++){
    for(let c=0;c<N;c++){
      const cell=document.createElement('div');
      cell.className='cell'; cell.tabIndex=0;
      cell.dataset.r=r; cell.dataset.c=c;

      const rule = rules[r][c];
      const d = ACTIVE_DESCS[rule.idx];
      const text = rule.negate ? d.neg : d.pos;

      cell.innerHTML = `
        <div class="desc">${text}</div>
        <div class="mark" data-mark>ã€€</div>
        <div class="sol" data-sol>âœ“</div>
      `;
      cell.addEventListener('click',()=>advance(r,c));
      cell.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); advance(r,c); }});
      boardEl.appendChild(cell);
    }
  }
}

document.getElementById('btn-reset').addEventListener('click',()=>{
  board = makeEmpty(N);
  render();
});
document.getElementById('btn-new').addEventListener('click',()=> newPuzzle());
btnSolution.addEventListener('click',()=>{
  showSolution = !showSolution;
  btnSolution.textContent = showSolution ? 'éš±è—è§£ç­”' : 'é¡¯ç¤ºè§£ç­”';
  render();
});
sizeSel.addEventListener('change',()=>{
  N = parseInt(sizeSel.value,10);
  board = makeEmpty(N); answer = makeEmpty(N); rules = makeEmpty(N);
  newPuzzle();
});

/* ============ å°å·¥å…·ï¼ˆç¸®å­—åªåœ¨æ–°é¡Œ/æ”¹å°ºå¯¸/è¦–çª—æ”¹è®Šæ™‚è§¸ç™¼ï¼‰ ============ */
function makeEmpty(n){ return Array.from({length:n},()=>Array.from({length:n},()=>BLANK)); }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }
const MIN_FONT_PX=9;
function fitDescriptionForCell(cell){
  const desc=cell.querySelector('.desc'); const mark=cell.querySelector('.mark'); if(!desc||!mark)return;
  const cellStyle=getComputedStyle(cell);
  const padTop=parseFloat(cellStyle.paddingTop)||0, padBottom=parseFloat(cellStyle.paddingBottom)||0, rowGap=parseFloat(cellStyle.rowGap)||6;
  const available = cell.clientHeight - padTop - padBottom - mark.offsetHeight - rowGap*1.2;
  if(available<=0) return;
  const start=Math.max(parseFloat(getComputedStyle(desc).fontSize)||14,12);
  let hi=start, lo=MIN_FONT_PX; desc.style.maxHeight=available+'px'; desc.style.fontSize=hi+'px';
  let guard=0; while(desc.scrollHeight>available && hi>lo && guard++<8){ hi=Math.max(lo,hi-2); desc.style.fontSize=hi+'px'; }
  for(let i=0;i<16;i++){ if(desc.scrollHeight<=available) break; const mid=(hi+lo)/2; hi=mid; desc.style.fontSize=hi+'px'; }
  if(desc.scrollHeight>available) desc.style.fontSize=lo+'px';
}
function fitAllDescriptions(){ document.querySelectorAll('.cell').forEach(fitDescriptionForCell); }
window.addEventListener('resize',()=>requestAnimationFrame(fitAllDescriptions));
window.addEventListener('orientationchange',()=>setTimeout(fitAllDescriptions,150));

/* ============ å•Ÿå‹• ============ */
renderBoardSkeleton();
newPuzzle(); // é è¨­ 4Ã—4
</script>
</body>
</html>
